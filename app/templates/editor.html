{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-3">
    
    <div class="row mb-3">
        <div class="col-12 bg-dark p-3 rounded d-flex align-items-center gap-2 flex-wrap">
            <select id="style-selector" class="form-select form-select-sm w-auto">
                <option value="style-clean">Clean White</option>
                <option value="style-ig-glow">IG Glow ğŸ’§</option>
                <option value="style-ig-green">IG Neon ğŸ</option>
                <option value="style-emoji">Emoji Mode ğŸ˜œ</option>
            </select>

            <select id="pos-selector" class="form-select form-select-sm w-auto">
                <option value="pos-top">Top</option>
                <option value="pos-center">Center</option>
                <option value="pos-bottom" selected>Bottom</option>
            </select>

            <select id="anim-selector" class="form-select form-select-sm w-auto">
                <option value="anim-none">No Anim</option>
                <option value="anim-pop">Pop In ğŸ’¥</option>
                <option value="anim-slide">Slide Up â¬†ï¸</option>
                <option value="anim-bounce">Bounce ğŸ€</option>
                <option value="anim-karaoke">Karaoke ğŸ¤</option>
            </select>

          
            
            <button id="render-btn" class="btn btn-primary btn-sm fw-bold">Export Video</button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-lg border-0 bg-black">
                
                <div class="card-body bg-black p-4 d-flex justify-content-center align-items-center" style="min-height: 500px;">
                    
                    <div class="video-wrapper">
                        <video id="main-video" controls>
                            <source src="{{ url_for('main.serve_media', filename='uploads/' + filename) }}" type="video/mp4">
                        </video>

                        <div id="lyric-overlay" class="pos-bottom">
                            <h2 id="current-lyric" class="style-clean px-3 text-center transition-all">...</h2>
                        </div>
                    </div>

                </div>
                
                <div id="progress-container" class="card-footer bg-dark border-0 d-none">
                    <small class="text-white mb-1 d-block">Rendering Status: <span id="progress-status" class="text-warning">Waiting...</span></small>
                    <div class="progress" style="height: 6px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between">
                    <span>Lyrics Editor</span>
                    <button id="save-btn" class="btn btn-sm btn-success">Save Changes</button>
                </div>
                <div class="card-body p-0" style="overflow-y: scroll; height: 500px;">
                    <div id="transcript-list" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const video = document.getElementById("main-video");
    const overlay = document.getElementById("lyric-overlay");
    const lyricDisplay = document.getElementById("current-lyric");
    const transcriptList = document.getElementById("transcript-list");
    
    // Controls
    const styleSelector = document.getElementById("style-selector");
    const posSelector = document.getElementById("pos-selector");
    const animSelector = document.getElementById("anim-selector");
    
    let lyricData = [];
    const filename = "{{ filename }}";
    
    // 1. Load Data
    fetch("{{ url_for('main.get_data', filename=filename) }}")
        .then(res => res.json())
        .then(data => { lyricData = data.segments; renderList(); });

    // 2. Video Sync
    video.addEventListener("timeupdate", () => {
        const t = video.currentTime;
        const seg = lyricData.find(s => t >= s.start && t <= s.end);
        if (seg) {
            lyricDisplay.innerText = seg.word;
            lyricDisplay.style.opacity = 1;
        } else {
            lyricDisplay.innerText = "";
        }
    });

    // 3. UI Update Logic
    function updateClasses() {
        lyricDisplay.className = "px-3 text-center transition-all"; 
        lyricDisplay.classList.add(styleSelector.value);
        if (animSelector.value !== 'anim-none') {
            lyricDisplay.classList.add(animSelector.value);
        }
        overlay.className = ""; 
        overlay.classList.add(posSelector.value); 
    }
    styleSelector.addEventListener("change", updateClasses);
    posSelector.addEventListener("change", updateClasses);
    animSelector.addEventListener("change", updateClasses);
    updateClasses();

    // 4. RENDER BUTTON (Synchronous)
    document.getElementById("render-btn").addEventListener("click", () => {
        const btn = document.getElementById("render-btn");
        const statusText = document.getElementById("progress-status");
        
        btn.disabled = true;
        btn.innerText = "Processing...";
        document.getElementById("progress-container").classList.remove("d-none");
        statusText.innerText = "Rendering... (Please wait, do not close tab)";
        
        fetch("/render", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                filename: filename,
                style: styleSelector.value,
                animation: animSelector.value,
                position: posSelector.value
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                statusText.innerText = "Done!";
                window.location.href = data.download_url;
            } else {
                alert("Error: " + data.message);
            }
            btn.disabled = false;
            btn.innerText = "Export Video";
        })
        .catch(err => {
            alert("Timeout or Error. Try a shorter video.");
            btn.disabled = false;
        });
    });

    function renderList() {
        transcriptList.innerHTML = "";
        lyricData.forEach((seg, i) => {
            const div = document.createElement("div");
            div.className = "list-group-item p-2 d-flex align-items-center";
            div.innerHTML = `<span class="badge bg-light text-dark me-2" style="cursor:pointer">${seg.start.toFixed(1)}s</span>
                             <input class="form-control border-0 fw-bold" value="${seg.word}">`;
            div.querySelector("input").oninput = (e) => lyricData[i].word = e.target.value;
            div.querySelector(".badge").onclick = () => { video.currentTime = seg.start; video.play(); };
            transcriptList.appendChild(div);
        });
    }

    document.getElementById("save-btn").addEventListener("click", function() {
        fetch("{{ url_for('main.update_data', filename=filename) }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ segments: lyricData })
        }).then(() => alert("Saved!"));
    });
});
</script>
{% endblock %}